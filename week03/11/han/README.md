# 네트워크 3

NAT을 사용해 IP 부족 문제를 넘기고 있음

NAT은 외부로 갈때 IP주소를 바꾸는데 (바꾸지 않으면 돌아올떄 유일한 주소가 아니니 모름)

그럼 받는 애는 라우터에서 왔다고 생각하게 됨. 그 안의 존재는 몰라

리턴패킷이 오면 그 변환과정을 게이트웨이 라우터가 알기 때문에 다시 돌려준다

NAT라는건 보통 게이트웨이 라우터에서 동작

## NAT (Network Address Translation)
- IPv4 주소 부족 문제를 해결하기 위한 방식
- 게이트웨이 라우터가 [사설 IP <--> 공인 IP] 변환을 담당
- 변환된 공인 IP는 라우터의 인터페이스에 할당된 전 세계 고유 주소

##
- 내부 → 외부: 라우터가 사설 IP를 공인 IP로 변환
- 외부 → 내부: NAT 테이블을 참조하여 응답을 내부 호스트에 전달

> 외부에서 볼 때, 내부 호스트는 라우터 자신으로 보이며, 실제 발신자는 알 수 없음

### 라우터와 Subnet
- 라우터는 여러 인터페이스를 통해 여러 subnet의 멤버가 될 수 있음
- 각 인터페이스는 해당 subnet의 prefix를 따라야 함  
  예: 10.0.0.0/24 subnet → 10.0.0.1, 10.0.0.2 등

### NAT의 한계
1. 계층 간 침범  
   - 전송 계층 포트 번호 등을 네트워크 계층이 사용
2. 포트 번호 재사용 문제  
   - 원래 포트 정보가 변경되어 리턴 시 식별 어려움

---

## DHCP (Dynamic Host Configuration Protocol)

- 클라이언트가 네트워크에 접속할 때 필요한 설정 정보를 자동으로 할당
- 다음의 네 가지 정보 제공
  1. IP 주소
  2. Subnet Mask
  3. Default Gateway (라우터)
  4. DNS 서버 주소


> 일반적으로 DHCP 서버는 게이트웨이 라우터 내에서 동작


### DHCP 동작 순서
1. DHCP Discover (브로드캐스트)
   - 클라이언트가 IP 없이 0.0.0.0에서 시작, 포트 68 사용
   - 목적지는 255.255.255.255, 서버는 포트 67 수신

2. DHCP Offer
   - 서버가 사용 가능한 IP와 설정 정보 제공 (브로드캐스트)

3. DHCP Request
   - 클라이언트가 특정 서버의 Offer를 수락
   - 다른 서버들에게는 거절 신호도 포함 (브로드캐스트)

4. DHCP ACK
   - 서버가 설정 정보 확정 및 임대 완료

### 임대와 회수
- IP는 일정 시간 동안만 사용 가능 (예: 1시간)
- 만료 시 회수되며, 필요하면 갱신 요청
- DHCP를 통해 주소 공간을 효율적으로 분배 가능


## 공유기와 게이트웨이 라우터

- 일반적인 무선 공유기에는 다음 기능이 내장됨
  - NAT
  - DHCP Server
  - DNS Server
- 가정 내 모든 장치의 IP는 동일한 prefix를 사용
- 외부에서는 하나의 공인 IP로 보임
- 공유기의 내부 주소는 일반적으로 (prefix).1 형식



## IP Fragmentation (IPv4 단편화)

### 단편화 개념
- 네트워크 링크마다 MTU(Maximum Transmission Unit)가 다름
- IP 패킷이 MTU보다 크면 분할(Fragmentation) 필요
- 분할된 패킷은 독립적으로 전송, 목적지에서 재조립

### 사용되는 필드
- Identifier: 패킷 단위의 고유 ID
- Flags: 뒤에 더 조각이 있는지를 나타냄
- Fragment Offset: 원래 데이터에서 해당 조각의 시작 위치 (8바이트 단위)

### 예시
- 4000 bytes IP 패킷 (헤더 20 bytes → 실제 데이터 3980 bytes)
- MTU = 1500 bytes → 1480 bytes씩 나눠서 전송

1. 첫 번째
   - 데이터: 1480 bytes  
   - Offset: 0  
   - Flags: 1 (뒤에 더 있음)
2. 두 번째
   - 데이터: 1480 bytes  
   - Offset: 1480 / 8 = 185  
   - Flags: 1
3. 세 번째
   - 데이터: 1020 bytes  
   - Offset: 2960 / 8 = 370  
   - Flags: 0 (마지막 조각)

> 조각 중 하나라도 손실되면 재조립 실패, 상위 계층에 전달되지 않음  
> TCP에서 재전송을 트리거함
