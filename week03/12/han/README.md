# 네트워크 4


## ICMP (Internet Control Message Protocol)

### ICMP란?
- **IP는 사용자 데이터를 전송하는 프로토콜**
  - 헤더: 목적지 주소 등
  - 데이터: TCP segment 등 사용자의 실제 메시지
- **ICMP는 사용자 데이터가 아닌 제어 메시지를 전달하는 프로토콜**
  - 네트워크 상의 오류, 상태 등을 알리기 위해 사용
  - IP 패킷 내부에 포함되며, 제어 목적의 데이터

### 왜 필요한가?
- 예시 1: 목적지 포트가 열려있지 않아 패킷이 드롭되어도 소스는 이유를 알 수 없음
- 예시 2: TTL(Time To Live) 필드가 0이 되어 패킷이 라우터에서 드롭될 때도 원인을 모름
- → 소스에게 네트워크 내부 상태를 알려줄 수단이 필요
- ICMP는 이러한 오류 발생 시 생성되는 **네트워크의 메시지**를 전달

### ICMP 메시지 예시
- **Type 11, Code 0**: TTL 만료로 인한 패킷 드롭

---

## ICMP 활용 예: `traceroute`

### 동작 원리
- 목적지까지 경유하는 라우터들의 IP 주소를 확인
- TTL 값을 1부터 시작해 점차 늘리면서 패킷을 전송
  - TTL 1 → 첫 번째 라우터에서 ICMP 메시지 생성
  - TTL 2 → 두 번째 라우터...
- 각 TTL마다 ICMP 응답을 통해 경유 라우터 확인 가능

---

## IPv6

### 개요
- 20년 전에 제안되었지만 IPv6가 아닌 **새로운 프로토콜**로 전환될 가능성도 있음
- **IPv4보다 헤더 구조가 단순**
  - 128비트 주소
  - Flow Label 등 정의는 되어 있으나 실제 사용법에 대한 합의 부족

### 과도기: 터널링 필요
- IPv4 네트워크와 공존하는 과도기에는 **터널링(tunneling)** 기술 필요
  - IPv6 패킷을 IPv4 패킷의 데이터로 삽입
  - IPv4 헤더를 덧붙여 중간 라우터가 이해할 수 있도록 전달

> 중요한 점은 무엇으로 바뀌든 과도기 동안 **터널링은 필수**라는 것

---

## IP Forwarding vs Routing

### Forwarding
- 라우터의 핵심 기능: 목적지 IP 주소를 기준으로 **Forwarding Table**을 참조해 다음 홉으로 전송
- **Longest Prefix Match** 방식 사용

### Routing
- Forwarding Table을 **채우는 과정이 라우팅**
- 라우터 간 최적 경로 계산이 필요

---

## 네트워크는 그래프다

- 라우터 = 노드  
- 링크 = 엣지 (링크의 cost 존재)
- 목적지까지 **최소 cost 경로**를 찾는 것이 핵심

---

## 라우팅 알고리즘: 두 가지 방식

| 방식             | 설명 |
|------------------|------|
| Link State       | 네트워크 전체 상황(그래프)을 알고 있음 |
| Distance Vector  | 이웃과 정보 교환을 통해 최단 경로 추론 |

---

## Link State Routing

### 개요
- 모든 노드가 자신의 **링크 상태**(이웃과의 연결 상태)를 브로드캐스트
- 전체 네트워크 그래프를 로컬에 구성한 후 **Dijkstra 알고리즘**으로 최단 경로 계산

### 주요 변수
- `c(x, y)`: x와 y 사이의 cost (연결 없으면 ∞)
- `N'`: 현재까지 최단 경로가 확정된 노드의 집합
- `D(v)`: 노드 u에서 v까지의 현재까지 알려진 최단 거리
- `p(v)`: v까지의 경로에서 바로 직전 노드

### 알고리즘 순서
1. 초기화  
   - 시작 노드는 거리 0, 나머지는 ∞  
   - 인접 노드는 직접 거리로 설정  
   - `p(v)`는 시작 노드로 설정

2. 반복 수행  
   - `N'`에 속하지 않은 노드 중 D값이 최소인 노드 `w`를 선택, `N'`에 추가  
   - `w`의 이웃 중 `N'`에 없는 노드의 D값을 다음 식으로 업데이트  
     ```
     D(v) = min(D(v), D(w) + c(w,v))
     ```

3. 모든 노드가 `N'`에 포함될 때까지 반복

---

## Dijkstra 예시 요약

- 시작: u
- u → w → v → y → z 로 경로 확정
- 최단 경로는 `p(v)` 값들을 추적해 구성
- **Forwarding Table**의 각 목적지에 대해 **다음 홉(next hop)**을 결정

---

## Link State의 한계

### 트래픽에 따라 link cost가 변할 때
- 트래픽 변화에 따라 경로가 계속 바뀜 → 경로 진동
- 예: 시계방향, 반시계방향 반복 → 불안정

### 브로드캐스트 범위 제한
- 전 세계 모든 라우터에 브로드캐스트는 불가능
- 일반적으로 **자치 도메인(AS)** 단위로 제한
  - 내부에서는 가능
  - 외부는 자율적 선택

